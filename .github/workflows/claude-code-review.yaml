name: Claude Code Review

on:
  pull_request:
    types: [opened, ready_for_review]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  debug-author-association:
    runs-on: ubuntu-latest
    steps:
      - name: Show PR author_association value
        run: |
          echo "author_association='${{ github.event.pull_request.author_association }}'"
          echo "Raw JSON:"
          echo '${{ toJSON(github.event.pull_request.author_association) }}'

  claude-review:
    # Security: Only run on PRs from collaborators to prevent malicious code execution
    if: |
      github.event.pull_request.author_association == 'OWNER' ||
      github.event.pull_request.author_association == 'MEMBER' ||
      github.event.pull_request.author_association == 'COLLABORATOR' ||
      github.event.pull_request.author_association == 'CONTRIBUTOR'

    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Direct prompt for automated review (no @claude mention needed)
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request with the following structure:

            ## 1. Is the requirement justified?
            Evaluate whether the PR author has adequately explained WHY this change is needed.
            Often this is a reference to a decision that's already described in an issue, or a bug report.
            Does the author demonstrate understanding of the requirement?

            ## 2. Does the patch meet the requirement?
            Evaluate whether the PR author has explained HOW the implementation addresses the requirement.
            Does it solve the stated problem without breaking other things?
            Has the author demonstrated understanding of their implementation?

            ## 3. What Needs Human Review üßë‚Äçüíª
            Explicitly flag items that require human judgment:
            - Design decisions and trade-offs that need team discussion
            - Business logic that requires domain expertise
            - Breaking changes or API modifications
            - Security-sensitive code that needs expert review
            - Performance implications that need profiling/testing
            - Areas where you're uncertain or found ambiguity

            ## 4. Automated Review Findings ‚úÖ
            Technical items that can be verified programmatically:
            - Code quality and best practices
            - Potential bugs or issues (with severity: P0-P4)
            - Test coverage gaps
            - Type safety and validation
            - Documentation completeness

            ## 5. Security & Performance
            - Security concerns (if any)
            - Performance considerations (if any)

            ## 6. Recommendation
            Clear approve/request changes decision with rationale.

            Be constructive, specific, and cite line numbers where relevant.
            Prioritize findings (P0=blocking, P1=important, P2=nice-to-have, P3-P4=optional).

          # Additional configuration via CLI arguments
          claude_args: |
            --system-prompt "Follow our coding standards"
